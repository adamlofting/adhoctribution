<!DOCTYPE html>
<html class="no-js">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Ad hoc Contribution Logger</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" href="css/bootstrap.min.css">
        <style>
            body {
                padding-top: 70px;
                padding-bottom: 20px;
            }
        </style>
        <link rel="stylesheet" href="css/bootstrap-theme.min.css">
        <link rel="stylesheet" href="css/main.css">

    </head>
    <body>
    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <span class="navbar-brand">Ad hoc Contribution Logger</span>
        </div>
      </div>
    </div>

    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="container">
      <div class="row">
        <div class="col-sm-10">
          {{{body}}}
        </div>
        <div class="col-sm-2">
          {{#if authorized}}
            <p class="small text-right">{{{username}}}</p>
            <button id="logout" class="btn btn-xs btn-warning pull-right">Sign out</button>
          {{else}}
            <br />
            <a id="login" class="btn btn-primary btn-lg pull-right" role="button">Sign in &raquo;</a>
          {{/if}}
        </div>
      </div>
    </div>


    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="/js/vendor/jquery-1.11.0.min.js"><\/script>')</script>
    <script src="/bower/jquery.validation/dist/jquery.validate.min.js"></script>

    <script src="/js/vendor/bootstrap.min.js"></script>
		<script src="https://login.persona.org/include.js"></script>
		<script type="text/javascript">
    var login = document.querySelector("#login");
		if (login) {
      login.addEventListener("click", function() {
  		  navigator.id.request();
  		}, false);
    }

    var logout = document.querySelector("#logout")
    if (logout) {
      logout.addEventListener("click", function() {
        navigator.id.logout();
      }, false);
    }

    var currentUser = null;
    {{#if currentUser}}
    var currentUser = "{{{currentUser}}}";
    {{/if}}

		navigator.id.watch({
      loggedInUser: currentUser,
		  onlogin: function(assertion) {
		    // var xhr = new XMLHttpRequest();
		    // xhr.open("POST", "/persona/verify", true);
		    // xhr.setRequestHeader("Content-Type", "application/json");
		    // xhr.addEventListener("loadend", function(e) {
		    //   var data = JSON.parse(this.responseText);
		    //   if (data && data.status === "okay") {
		    //     console.log("You have been logged in as: " + data.email);
		    //   }
		    // }, false);

		    // xhr.send(JSON.stringify({
		    //   assertion: assertion
		    // }));

        $.ajax({ /* <-- This example uses jQuery, but you can use whatever you'd like */
          type: 'POST',
          url: '/persona/verify',
          data: { assertion: assertion },
          success: function(res, status, xhr) {
            window.location.reload();
          },
          error: function(xhr, status, err) {
            navigator.id.logout();
            alert("Login failure: " + err);
          }
        });
		  },
		  onlogout: function() {
		    // var xhr = new XMLHttpRequest();
		    // xhr.open("POST", "/persona/logout", true);
		    // xhr.addEventListener("loadend", function(e) {
		    //   console.log("You have been logged out");
		    // });
		    // xhr.send();

        $.ajax({
          type: 'POST',
          url: '/persona/logout',
          success: function(res, status, xhr) { window.location.reload(); },
          error: function(xhr, status, err) { alert("Logout failure: " + err); }
        });
		  }
		});</script>
        <script src="js/main.js"></script>
    </body>
</html>